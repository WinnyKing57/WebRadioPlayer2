name: Build APK

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip openjdk-11-jdk git unzip
        pip install buildozer cython
        # Set ANDROID_SDK_ROOT and ANDROID_HOME just in case Buildozer picks them up,
        # but primarily we'll let Buildozer manage its own SDK download.
        # These paths might be used by Buildozer to decide where to place its downloaded SDK.
        export ANDROID_SDK_ROOT=${HOME}/.buildozer/android/platform/android-sdk
        export ANDROID_HOME=${HOME}/.buildozer/android/platform/android-sdk
        echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}" >> $GITHUB_ENV
        echo "ANDROID_HOME=${ANDROID_HOME}" >> $GITHUB_ENV
        # It's also good practice to ensure the .buildozer directory can be written to by the runner user
        mkdir -p ${HOME}/.buildozer/

    - name: Accept Android licenses
      run: |
        # ANDROID_SDK_ROOT is now ${HOME}/.buildozer/android/platform/android-sdk
        # Create license directories in common locations.
        mkdir -p ${ANDROID_SDK_ROOT}/licenses
        mkdir -p ${HOME}/.android/licenses

        # Pre-accept common licenses by writing their hashes to files.
        # Buildozer's internal SDK manager might pick these up.
        LICENSE_DIR_1=${ANDROID_SDK_ROOT}/licenses
        LICENSE_DIR_2=${HOME}/.android/licenses

        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" | tee ${LICENSE_DIR_1}/android-sdk-license ${LICENSE_DIR_2}/android-sdk-license > /dev/null
        echo "84831b9409646a918e30573bab4c9c91346d8abd" | tee ${LICENSE_DIR_1}/android-sdk-preview-license ${LICENSE_DIR_2}/android-sdk-preview-license > /dev/null
        echo "d975f751698a77b662f1254ddbeed3901e976f5a" | tee ${LICENSE_DIR_1}/android-sdk-arm-dbt-license ${LICENSE_DIR_2}/android-sdk-arm-dbt-license > /dev/null
        echo "fd6b01a7e7a4e4f37591efa21e1a51710ac17ef4" | tee ${LICENSE_DIR_1}/intel-android-extra-license ${LICENSE_DIR_2}/intel-android-extra-license > /dev/null
        # Add the hash that was specifically problematic for build-tools;36.0.0, just in case.
        # The problematic hash for "Android SDK Build-Tools 36" if known, could be added.
        # However, since we don't have a specific hash for "build-tools;36.0.0" from the logs,
        # we'll rely on the `buildozer android update -p` step to handle this.
        # For now, the generic ones are included.

        echo "Pre-accepted some common Android SDK licenses."

    - name: Build APK
      run: |
        yes | buildozer android update -p
        buildozer -v android debug
        ls -la bin/

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: webradio-apk
        path: bin/*.apk
